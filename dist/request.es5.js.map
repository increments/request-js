{"version":3,"file":"request.es5.js","sources":["../src/index.ts"],"sourcesContent":["export interface Headers {\n  [key: string]: string\n}\n\nexport type Param = string | number | Date | null\n\nexport interface Params {\n  [key: string]: Param | Param[]\n}\n\nexport interface Config {\n  data?: any // `data` is the data to be sent as the request body.\n  headers?: Headers // `headers` are custom headers to be sent.\n  params?: Params // `params` are the URL parameters to be sent with the request.\n  timeout?: number // `timeout` specifies the number of milliseconds before the request times out.\n}\n\nconst defaultHeaders: Headers = {}\n\nexport function setDefaultHeaders(headers: { [key: string]: string }) {\n  Object.keys(headers).forEach(key => {\n    defaultHeaders[key] = headers[key]\n  })\n}\n\nexport class Response<T> {\n  public data: T\n  public status: number\n  public statusText: string\n  public headers: Headers\n  public config: Config\n  public request: XMLHttpRequest\n\n  constructor(xhr: XMLHttpRequest, config: Config) {\n    this.data = this.parseResponse(xhr.response)\n    this.status = xhr.status\n    this.statusText = xhr.statusText\n    this.headers = this.parseHeaders(xhr.getAllResponseHeaders().split(\"\\n\"))\n    this.request = xhr\n    this.config = config\n  }\n\n  public isSuccess(): boolean {\n    return 200 <= this.status && this.status < 300\n  }\n\n  private parseResponse(data: any) {\n    if (typeof data === \"string\") {\n      try {\n        data = JSON.parse(data)\n      } catch (e) {\n        /* Ignore */\n      }\n    }\n    return data\n  }\n\n  private parseHeaders(lines: string[]): Headers {\n    return lines.reduce((headers: Headers, line) => {\n      const kv = line.split(\":\", 2)\n      const key = kv[0].trim().toLocaleLowerCase()\n      const value = kv[1] ? kv[1].trim() : \"\"\n      if (key) {\n        headers[key] = headers[key] ? `${headers[key]}, ${value}` : value\n      }\n      return headers\n    }, {})\n  }\n}\n\nclass RequestError extends Error {\n  public config: Config\n  public code: string | null | undefined\n  public request: XMLHttpRequest\n\n  constructor(\n    message: string,\n    config: Config,\n    code: string | null | undefined,\n    req: XMLHttpRequest,\n  ) {\n    super(message)\n    this.config = config\n    this.code = code\n    this.request = req\n  }\n}\n\n// Bulid a URL by appending params to the end.\nexport function buildUrl(url: string, params: Params): string {\n  const parts: string[] = []\n  for (let key in params) {\n    if (params.hasOwnProperty(key)) {\n      let value = params[key]\n      if (Array.isArray(value)) {\n        key += \"[]\"\n      } else {\n        value = [value]\n      }\n      for (let v of value) {\n        if (v == null) {\n          continue\n        } else if (v instanceof Date) {\n          v = v.toISOString()\n        }\n        parts.push(`${key}=${encodeURIComponent(v.toString())}`)\n      }\n    }\n  }\n  return parts.length\n    ? url + (url.indexOf(\"?\") === -1 ? \"?\" : \"&\") + parts.join(\"&\")\n    : url\n}\n\nexport function request<T>(\n  method: \"GET\" | \"DELETE\" | \"HEAD\" | \"OPTIONS\" | \"POST\" | \"PUT\" | \"PATCH\",\n  url: string,\n  config: Config = {},\n): Promise<Response<T>> {\n  return new Promise((resolve, reject) => {\n    let xhr: XMLHttpRequest | null = new XMLHttpRequest()\n\n    const headers: { [key: string]: string } = {\n      ...defaultHeaders,\n      ...config.headers,\n    }\n\n    xhr.open(method, config.params ? buildUrl(url, config.params) : url, true)\n    xhr.onload = () => {\n      if (xhr) {\n        resolve(new Response(xhr, config))\n        xhr = null // Clean up to fix circular reference in order to avoid memory leak\n      }\n    }\n    xhr.onerror = () => {\n      if (xhr) {\n        reject(new RequestError(\"Network Error\", config, null, xhr))\n        xhr = null\n      }\n    }\n    xhr.ontimeout = () => {\n      if (xhr && config.timeout) {\n        reject(\n          new RequestError(\n            `Timeout of ${config.timeout} ms exceeded`,\n            config,\n            \"ECONNABORTED\",\n            xhr,\n          ),\n        )\n        xhr = null\n      }\n    }\n    for (const key in headers) {\n      if (headers.hasOwnProperty(key)) {\n        xhr.setRequestHeader(key, headers[key])\n      }\n    }\n    if (config.timeout) {\n      xhr.timeout = config.timeout\n    }\n\n    let configData = config.data\n    if (\n      typeof configData === \"object\" &&\n      headers[\"Content-Type\"] === \"application/json;charset=UTF-8\"\n    ) {\n      configData = JSON.stringify(configData)\n    }\n\n    xhr.send(configData !== undefined ? configData : null)\n  })\n}\n"],"names":[],"mappings":"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"}