{"version":3,"file":"index.es.js","sources":["../src/index.ts"],"sourcesContent":["export interface Headers {\n  [key: string]: string\n}\n\nexport type Param = string | number | Date | null\n\nexport interface Params {\n  [key: string]: Param | Param[]\n}\n\nexport interface Config {\n  data?: any // `data` is the data to be sent as the request body.\n  headers?: Headers // `headers` are custom headers to be sent.\n  params?: Params // `params` are the URL parameters to be sent with the request.\n  timeout?: number // `timeout` specifies the number of milliseconds before the request times out.\n}\n\nconst defaultHeaders: Headers = {}\n\nexport function setDefaultHeaders(headers: { [key: string]: string }) {\n  Object.keys(headers).forEach(key => {\n    defaultHeaders[key] = headers[key]\n  })\n}\n\nexport class Response<T, S> {\n  public data: T\n  public status: number\n  public statusText: string\n  public headers: Headers\n  public config: Config\n  public request: XMLHttpRequest\n  public isSuccess: S\n\n  constructor(xhr: XMLHttpRequest, config: Config, isSuccess: S) {\n    this.data = this.parseResponse(xhr.response)\n    this.status = xhr.status\n    this.statusText = xhr.statusText\n    this.headers = this.parseHeaders(xhr.getAllResponseHeaders().split(\"\\n\"))\n    this.request = xhr\n    this.config = config\n    this.isSuccess = isSuccess\n  }\n\n  private parseResponse(data: any) {\n    if (typeof data === \"string\") {\n      try {\n        data = JSON.parse(data)\n      } catch (e) {\n        /* Ignore */\n      }\n    }\n    return data\n  }\n\n  private parseHeaders(lines: string[]): Headers {\n    return lines.reduce((headers: Headers, line) => {\n      const kv = line.split(\":\", 2)\n      const key = kv[0].trim().toLocaleLowerCase()\n      const value = kv[1] ? kv[1].trim() : \"\"\n      if (key) {\n        headers[key] = headers[key] ? `${headers[key]}, ${value}` : value\n      }\n      return headers\n    }, {})\n  }\n}\n\nclass RequestError extends Error {\n  public config: Config\n  public code: string | null | undefined\n  public request: XMLHttpRequest\n\n  constructor(\n    message: string,\n    config: Config,\n    code: string | null | undefined,\n    req: XMLHttpRequest,\n  ) {\n    super(message)\n    this.config = config\n    this.code = code\n    this.request = req\n  }\n}\n\n// Bulid a URL by appending params to the end.\nexport function buildUrl(url: string, params: Params): string {\n  const parts: string[] = []\n  for (let key in params) {\n    if (params.hasOwnProperty(key)) {\n      let value = params[key]\n      if (Array.isArray(value)) {\n        key += \"[]\"\n      } else {\n        value = [value]\n      }\n      for (let v of value) {\n        if (v == null) {\n          continue\n        } else if (v instanceof Date) {\n          v = v.toISOString()\n        }\n        parts.push(`${key}=${encodeURIComponent(v.toString())}`)\n      }\n    }\n  }\n  return parts.length\n    ? url + (url.indexOf(\"?\") === -1 ? \"?\" : \"&\") + parts.join(\"&\")\n    : url\n}\n\nexport function request<T = any, F = any>(\n  method: \"GET\" | \"DELETE\" | \"HEAD\" | \"OPTIONS\" | \"POST\" | \"PUT\" | \"PATCH\",\n  url: string,\n  config: Config = {},\n): Promise<Response<T, true> | Response<F, false>> {\n  return new Promise((resolve, reject) => {\n    let xhr: XMLHttpRequest | null = new XMLHttpRequest()\n\n    const headers: { [key: string]: string } = {\n      ...defaultHeaders,\n      ...config.headers,\n    }\n\n    xhr.open(method, config.params ? buildUrl(url, config.params) : url, true)\n    xhr.onload = () => {\n      if (xhr) {\n        resolve(new Response(\n          xhr,\n          config,\n          200 <= xhr.status && xhr.status < 300,\n        ) as any)\n        xhr = null // Clean up to fix circular reference in order to avoid memory leak\n      }\n    }\n    xhr.onerror = () => {\n      if (xhr) {\n        reject(new RequestError(\"Network Error\", config, null, xhr))\n        xhr = null\n      }\n    }\n    xhr.ontimeout = () => {\n      if (xhr && config.timeout) {\n        reject(\n          new RequestError(\n            `Timeout of ${config.timeout} ms exceeded`,\n            config,\n            \"ECONNABORTED\",\n            xhr,\n          ),\n        )\n        xhr = null\n      }\n    }\n    for (const key in headers) {\n      if (headers.hasOwnProperty(key)) {\n        xhr.setRequestHeader(key, headers[key])\n      }\n    }\n    if (config.timeout) {\n      xhr.timeout = config.timeout\n    }\n\n    let configData = config.data\n    if (\n      typeof configData === \"object\" &&\n      headers[\"Content-Type\"] === \"application/json;charset=UTF-8\"\n    ) {\n      configData = JSON.stringify(configData)\n    }\n\n    xhr.send(configData !== undefined ? configData : null)\n  })\n}\n"],"names":[],"mappings":"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"}